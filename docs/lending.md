# Lending

## Structure

- LendingToken
- LendingEther
- LendingErc20

## LendingToken contract

Этот контракт содержит только internal методы, общие для LendingEther и LendingErc20. Эти методы вызываются из публичных методов данных контрактов.
Также контракт содержит неимплементированные методы получения и отправки денежных средств, имплементация которых зависит от того, являются данные средства Ether или ERC-20 токеном. Методы переопределены и имплементированы в соответствующих контрактах (LendingEther и LendingErc20).

## Создание контракта

Конструкторы контрактов LendingEther и LendingErc20 включают в себя создание контракта LendingToken.
Для создания контракта необходимо указать
- адрес контракта токена (address(0) в случае Ether)
- адрес governance контракта
- адрес основного контракта Franklin
- адрес контракта-верификатора
- адрес владельца контракта

При создании контракта произойдет проверка наличия токена в governance контракте.
Также из контракта Franklin будет получен последний верифицированный блок.

Governor контракта governance должен будет указать адрес созданного контракта в Franklin контракте путем вызова метода addLending(tokenId, lendingAddress).

## Пополенение счета **кредитора**

Кредиторы могут пополнить свой Ether счет напрямую путем вызова метода LendingEther контракта supply(to) с указанием value желаемого депозита в Ether.
Для пополнения счета в токенах ERC-20 необходимо на соответствующем контракте LendingErc20 вызвать метод supply(amount, to) с указание количества токенов amount.
Поле *to* существует для того, чтобы пользователь при желании мог пополнять счет другого пользователя.

При выполнении данных методов будет вызван внутренний метод supplyInternal(amount, to) контракта LendingToken. При этом произойдет поступление токенов ERC-20 на контракт через метод transferIn(amount) (Ether поступает без дополнительных затрат).

Далее будут созданы соответствующие записи в mapping'ах LendingToken контракта, отражающие зачисление средств на счет пользователя (по его ethereum адресу), а также увеличение доступных для займа средств.

## Состояние счета **кредитора**

Кредитор в любой момент может узнать баланс своего счета из mapping lendersSupplies, указав свой ethereum адрес в качестве ключа.

## Немеделенный вывод средств со счета **кредитора**

Кредитор может вывести средства со счета, привязанного к его ethereum адресу (кредитор ДОЛЖЕН владеть данным аккаунтом).

Для этого он вызывает метод withdraw(amount, to) на контрактах LendingEther и LendingErc20.
Поле *to* существует для того, чтобы пользователь при желании мог вывести средства на аккаунт другого пользователя.

ри выполнении данных методов будет вызван внутренний метод withdrawInternal(amount, to) контракта LendingToken. Пройдут проверки на наличие на аккаунте пользователя указанной суммы, а также наличия достаточного количества средств из числа незанятых.

На контракте LendingToken произойдут изменения в соответствующих записях, отразающих изменение баланса пользователя, уменьшится количество доступных для займа средств. Если пользователь выводит полную сумму то его аккаунт будет удален.

Для отправки средств будет вызван метод transferOut(amount, to) контрактов LendingEther или LendingErc20.

## Отложенный вывод средств со счета **кредитора**

In progress

## Запрос отправки средств **заемщиком**

При наличии подтверждения поступления определенного количества средств в будущем (наличие соответствующей транзакции в одном из Committed блоков сети Franklin), пользователь данной сети может отправить запрос на контракты  LendingEther и LendingErc20 для немедленной отправки указанных средств по некоему ethereum адресу.

Тем самым он займет свободные средства кредиторов. Данный долг будет погашен автоматически когда произойдет верификация указанного Franklin блока, содержащего данную транзакцию. При этом средства пользователя в сети Franklin будут изменены в результате данной транзакции на сумму, учитывающую вычет занятых средств.

Пользователь должен вызывать метод requestBorrow(txHash, signature, amount, borrower, receiver, blockNumber) контрактов LendingEther и LendingErc20.
Далее будет вызван метод requestBorrowInternal контракта LendingToken, на котором произойдут необходимые проверки:
- блок должен быть неверифицированным
- заемная сумма должа быть положительной
- верификация подписи должна быть успешной
- верификация транзакции в блоке должна быть успешной (в транзакции присутствует достаточно средств в указанной валюте, а назначением платежа является аккаунт пользователя-заемщика).

### Immediate borrow

Если есть достаточное количество свободных средств, то произвойдет немедленный заем в методе immediateBorrow, в противном случае будет создан запрос на заем (BorrowOrder) в методе defferedBorrow.

BorrowOrder привязан к соответствующему блоку и содержит информацию о сумме средств и назначении платежа.

### Deffered borrow

Кредитор может выполнить этот запрос по его идентефикатору в блоке запросов через метод fulfillOrder(blockNumber, orderId, sendingAmount, lender). Тем самым кредитор пополнит баланс своего аккаунта и заемных средств, а в результате будет вызван метод immediateBorrow, после которого запись о данном запросе будет удалена.

### Borrow process

В методе transferOut(amount, receiver) произойдет перечисление указанных средств с контракта по указанному адресу назначения платежа.

Будут расчитаны комиссионные средства для каждого кредитора и владельца контракта. Зачисление комиссионных произойдет при верификации указанного блока Franklin.

Также произойдет удержание указанного количества средств из доступных средств кредиторов.

Комиссии считаются в методе getCurrentInterestRates, который могут вызвать также кредиторы и пользователи для оценки необходимости для себя участвовать в процессе кредитования-займа.

## Fulfill borrow

При верификации очередного Franklin блока будут удалены запросы на займ, начислены комиссионные, а также освобождены занятые средства. Данная операция производится с контракта Franklin путем вызова метода newVerifiedBlock(blockNumber).

### Repay borrow

Средства поступят на контракт Lending через метод repayBorrow(amount) при его вызове из контракта Franklin. Данный вызов предполагается производить при верификации соответствующего Franklin блока.

## Расчет Interest Rate

Utilization ratio: 
u = totalBorrowed / (totalSupply + totatBorrowed)

Borrowing Interest Rate:
BIR = MULTIPLIER * u + BASE_RATE

Supply Interest Rate:
SIR = BIR * u * (1 - SPREAD)

Borrower fee:
borrowerFee = bir * amount

Lenders fees:
lendersFees = borrowerFee * SIR

Owner (Matter) fee:
ownerFee = borrowerFee - lendersFees

Single lender fee:
fee = lendersFees * (lendersSupplies[lenderId] / totalSupply)

